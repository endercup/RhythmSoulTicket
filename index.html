<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>驗票系統</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: black;
  overflow: hidden;
}
#camera-container {
  position: relative;
  width: 100vw;
  height: 100svh;
}
#qr-reader {
  width: 100%;
  height: 100%;
}
#qr-reader video {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
}
/* 固定綠色大框 */
#scan-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  z-index: 10;
}
.scan-box {
  width: 300px;
  height: 300px;
  border: 5px solid #00ff88;
  border-radius: 20px;
  box-shadow: 0 0 40px rgba(0, 255, 136, 0.8);
  background: transparent;
}
#full-result {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  z-index: 30;
  background: black;
}
.vip {
  color: gold;
  font-size: 56px;
  text-shadow: 0 0 20px gold;
}
.normal {
  font-size: 48px;
}
.checkmark {
  font-size: 80px;
  margin-bottom: 20px;
}
</style>
</head>
<body>
<div id="camera-container">
  <div id="qr-reader"></div>
  <!-- 固定綠色外框 -->
  <div id="scan-overlay">
    <div class="scan-box"></div>
  </div>
  <div id="full-result"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@latest"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbww-Mxw-aoWQ5dIYGNc7teyL7sPZDKtLdczzOCS-qA92ZzQeMAwtJLMEvIibY4z6OEF/exec";
const fullResult = document.getElementById("full-result");
let scanner;
let locked = false;
let lastProcessedCode = null;
let lastScanTime = 0;

/* 震動回饋 */
function vibrateSuccess() { if (navigator.vibrate) navigator.vibrate(300); }
function vibrateError() { if (navigator.vibrate) navigator.vibrate([100, 100, 100]); }

/* 全黑結果畫面 - 顯示 500ms */
function showFullResult(isSuccess, isVip = false, message = "") {
  if (isSuccess) {
    vibrateSuccess();
    fullResult.innerHTML = `
      <div class="checkmark">✓</div>
      ${isVip ? '<div class="vip">VIP<br>入場成功</div>' : '<div class="normal">入場成功</div>'}
    `;
  } else {
    vibrateError();
    fullResult.innerHTML = `
      <div class="normal">${message || '無效或已使用'}</div>
    `;
  }
  fullResult.style.display = "flex";
  setTimeout(() => {
    fullResult.style.display = "none";
    locked = false;
  }, 500);
}

/* 根據條碼前三位判斷是否為 VIP */
function isVipFromCode(code) {
  if (typeof code !== 'string') return false;
  const prefix = code.trim().substring(0, 3).toUpperCase();
  return prefix === 'VIP';
}

/* API 驗證（只負責檢查票券有效性，不再返回 vip 欄位） */
async function verifyTicket(id) {
  try {
    const res = await fetch(API_URL + "?id=" + encodeURIComponent(id), {
      cache: "no-cache"
    });
    const result = await res.json();

    // 這裡只看後端回傳的狀態，VIP 顯示由前端自行判斷
    if (result.status === "OK") {
      const vip = isVipFromCode(id);
      showFullResult(true, vip);
    } else if (result.status === "USED") {
      showFullResult(false, false, "票券已使用");
    } else if (result.status === "DUPLICATE") {
      locked = false; // 同張票重複掃描，直接解鎖不顯示
    } else {
      showFullResult(false);
    }
  } catch (err) {
    vibrateError();
    showFullResult(false, false, "網路錯誤");
    locked = false;
  }
}

/* 掃描成功回調 */
function onScan(decodedText) {
  const now = Date.now();
  const code = decodedText.trim();

  // 防重複機制
  if (now - lastScanTime < 80 && code === lastProcessedCode) return;
  if (locked) return;
  if (code === lastProcessedCode) return;

  locked = true;
  lastScanTime = now;
  lastProcessedCode = code;

  verifyTicket(code);
}

/* 掃描設定 */
const config = {
  fps: 35,
  qrbox: { width: 280, height: 280 },
  aspectRatio: 1,
  disableFlip: false,
  formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ],
  experimentalFeatures: {
    useBarCodeDetectorIfSupported: true
  }
};

/* 啟動掃描器 */
scanner = new Html5Qrcode("qr-reader");
scanner.start(
  { facingMode: "environment" },
  config,
  onScan,
  () => {}
).catch(err => {
  alert("無法啟動相機：" + err);
});
</script>
</body>
</html>
