<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>驗票系統</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: black;
  overflow: hidden;
}
#camera-container {
  position: relative;
  width: 100vw;
  height: 100svh;
}
#qr-reader {
  width: 100%;
  height: 100%;
}
#qr-reader video {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
}
#scan-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  z-index: 10;
}
/* 固定綠色掃描框（穩定不閃） */
.scan-box {
  width: 300px;
  height: 300px;
  border: 5px solid #00ff88;
  border-radius: 20px;
  box-shadow: 0 0 40px rgba(0, 255, 136, 0.8);
  background: transparent;
}

/* 徹底隱藏 html5-qrcode 所有內建視覺元素（四角綠白線、陰影、laser 等） */
#qr-reader > div,
#qr-reader canvas,
#qr-reader .qr-shaded-region,
#qr-reader [class*="qr-"],
#qr-reader [style*="border"],
#qr-reader [style*="position: absolute"] {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
}

#full-result {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  z-index: 30;
  background: black;
}
.vip {
  color: gold;
  font-size: 56px;
  text-shadow: 0 0 20px gold;
}
.normal {
  font-size: 48px;
}
.checkmark {
  font-size: 80px;
  margin-bottom: 20px;
}
</style>
</head>
<body>
<div id="camera-container">
  <div id="qr-reader"></div>
  <div id="scan-overlay">
    <div class="scan-box"></div>
  </div>
  <div id="full-result"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz4JomfGpFnOJYwcAJTyMiEulVqtlPHQNx9rID7Ixo7I5zReBqMBdrn_JSxdCHxQjbT/exec";
const fullResult = document.getElementById("full-result");

let scanner;
let locked = false;
let lastScanTime = 0;

/* 震動回饋 */
function vibrateSuccess() { if (navigator.vibrate) navigator.vibrate(300); }
function vibrateError() { if (navigator.vibrate) navigator.vibrate([100, 100, 100]); }

/* 全黑結果畫面 - 只顯示 500ms */
function showFullResult(isSuccess, isVip = false, message = "") {
  if (isSuccess) {
    vibrateSuccess();
    fullResult.innerHTML = `
      <div class="checkmark">✓</div>
      ${isVip ? '<div class="vip">VIP<br>入場成功</div>' : '<div class="normal">入場成功</div>'}
    `;
  } else {
    vibrateError();
    fullResult.innerHTML = `
      <div class="normal">${message || '無效或已使用'}</div>
    `;
  }

  fullResult.style.display = "flex";

  setTimeout(() => {
    fullResult.style.display = "none";
    locked = false;  // 0.5 秒後解鎖，可立即掃下一張
  }, 500);
}

/* API 驗證 */
async function verifyTicket(id) {
  try {
    const res = await fetch(API_URL + "?id=" + encodeURIComponent(id), { cache: "no-cache" });
    const result = await res.json();

    if (result.status === "OK") {
      showFullResult(true, result.vip);
    } else if (result.status === "USED") {
      showFullResult(false, false, "票券已使用");
    } else if (result.status === "DUPLICATE") {
      locked = false;
    } else {
      showFullResult(false);
    }
  } catch (err) {
    vibrateError();
    showFullResult(false, false, "網路錯誤");
  }
}

/* 掃描回調 - 防重複間隔 50ms（極快） */
function onScan(decodedText) {
  const now = Date.now();
  
  if (now - lastScanTime < 50 && decodedText === scanner.lastScanned) return;
  
  if (locked) return;
  locked = true;
  lastScanTime = now;
  scanner.lastScanned = decodedText;

  verifyTicket(decodedText.trim());
}

/* 掃描設定 */
const config = {
  fps: 35,
  qrbox: { width: 280, height: 280 },
  aspectRatio: 1,
  disableFlip: true,
  formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ],
  experimentalFeatures: {
    useBarCodeDetectorIfSupported: true
  }
};

/* 強制使用後置相機 */
Html5Qrcode.getCameras().then(cameras => {
  if (cameras && cameras.length) {
    let camera = cameras.find(cam => 
      cam.label && (cam.label.toLowerCase().includes("back") || cam.label.toLowerCase().includes("environment"))
    );
    if (!camera) camera = cameras.find(cam => cam.facingMode === "environment");
    if (!camera) camera = cameras[0];

    const cameraId = camera.id || { facingMode: "environment" };

    scanner = new Html5Qrcode("qr-reader");
    scanner.start(
      cameraId,
      config,
      onScan,
      () => {}
    ).catch(err => {
      alert("無法啟動相機：" + err);
    });
  } else {
    alert("未偵測到相機");
  }
}).catch(err => {
  alert("請允許相機權限");
});
</script>
</body>
</html>
