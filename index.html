<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>驗票系統</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: black;
  overflow: hidden;
}
#camera-container {
  position: relative;
  width: 100vw;
  height: 100svh;
}
#qr-reader {
  width: 100%;
  height: 100%;
}
#qr-reader video {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
}

/* 只保留我們自己的固定綠色大框（可選：如果你不想看到兩個框疊加，可以刪除下面這段） */
#scan-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  z-index: 10;
}
.scan-box {
  width: 300px;
  height: 300px;
  border: 5px solid #00ff88;
  border-radius: 20px;
  box-shadow: 0 0 40px rgba(0, 255, 136, 0.8);
  background: transparent;
}

#full-result {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  z-index: 30;
  background: black;
}
.vip {
  color: gold;
  font-size: 56px;
  text-shadow: 0 0 20px gold;
}
.normal {
  font-size: 48px;
}
.checkmark {
  font-size: 80px;
  margin-bottom: 20px;
}
</style>
</head>
<body>
<div id="camera-container">
  <div id="qr-reader"></div>
  <!-- 固定綠色外框（可保留或刪除，如果你只想看內建的閃爍框，可以刪除這整段） -->
  <div id="scan-overlay">
    <div class="scan-box"></div>
  </div>
  <div id="full-result"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz4JomfGpFnOJYwcAJTyMiEulVqtlPHQNx9rID7Ixo7I5zReBqMBdrn_JSxdCHxQjbT/exec";
const fullResult = document.getElementById("full-result");

let scanner;
let locked = false;
let lastScanTime = 0;

/* 震動回饋 */
function vibrateSuccess() { if (navigator.vibrate) navigator.vibrate(300); }
function vibrateError() { if (navigator.vibrate) navigator.vibrate([100, 100, 100]); }

/* 全黑結果畫面 - 只顯示 500ms */
function showFullResult(isSuccess, isVip = false, message = "") {
  if (isSuccess) {
    vibrateSuccess();
    fullResult.innerHTML = `
      <div class="checkmark">✓</div>
      ${isVip ? '<div class="vip">VIP<br>入場成功</div>' : '<div class="normal">入場成功</div>'}
    `;
  } else {
    vibrateError();
    fullResult.innerHTML = `
      <div class="normal">${message || '無效或已使用'}</div>
    `;
  }

  fullResult.style.display = "flex";

  setTimeout(() => {
    fullResult.style.display = "none";
    locked = false;
  }, 500);
}

/* API 驗證 */
async function verifyTicket(id) {
  try {
    const res = await fetch(API_URL + "?id=" + encodeURIComponent(id), { cache: "no-cache" });
    const result = await res.json();

    if (result.status === "OK") {
      showFullResult(true, result.vip);
    } else if (result.status === "USED") {
      showFullResult(false, false, "票券已使用");
    } else if (result.status === "DUPLICATE") {
      locked = false;
    } else {
      showFullResult(false);
    }
  } catch (err) {
    vibrateError();
    showFullResult(false, false, "網路錯誤");
  }
}

/* 掃描回調 - 防重複間隔 50ms */
function onScan(decodedText) {
  const now = Date.now();
  
  if (now - lastScanTime < 50 && decodedText === scanner.lastScanned) return;
  
  if (locked) return;
  locked = true;
  lastScanTime = now;
  scanner.lastScanned = decodedText;

  verifyTicket(decodedText.trim());
}

/* 掃描設定 - 恢復內建閃爍框 */
const config = {
  fps: 35,
  qrbox: { width: 280, height: 280 },
  aspectRatio: 1,
  disableFlip: false,  // 允許鏡像（前鏡頭需要）
  formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ],
  experimentalFeatures: {
    useBarCodeDetectorIfSupported: true
  }
};

/* 不鎖定相機 - 使用預設後置，但允許切換或系統自動選擇 */
scanner = new Html5Qrcode("qr-reader");
scanner.start(
  { facingMode: "environment" },  // 預設後置，但不會強制（手機允許時可切換）
  config,
  onScan,
  () => {}
).catch(err => {
  alert("無法啟動相機：" + err);
});
</script>
</body>
</html>
