<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>驗票系統</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: black;
  overflow: hidden;
}
#camera-container {
  position: relative;
  width: 100vw;
  height: 100svh;
}
#qr-reader {
  width: 100%;
  height: 100%;
}
#qr-reader video {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
}
/* 固定綠色大框 */
#scan-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  z-index: 10;
}
.scan-box {
  width: 300px;
  height: 300px;
  border: 5px solid #00ff88;
  border-radius: 20px;
  box-shadow: 0 0 40px rgba(0, 255, 136, 0.8);
  background: transparent;
}
#full-result {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  z-index: 30;
  background: black;
}
.vip {
  color: gold;
  font-size: 56px;
  text-shadow: 0 0 20px gold;
}
.normal {
  font-size: 48px;
}
.checkmark {
  font-size: 80px;
  margin-bottom: 20px;
}
</style>
</head>
<body>
<div id="camera-container">
  <div id="qr-reader"></div>
  <!-- 固定綠色外框 -->
  <div id="scan-overlay">
    <div class="scan-box"></div>
  </div>
  <div id="full-result"></div>
</div>

<!-- 使用最新版 html5-qrcode（建議） -->
<script src="https://unpkg.com/html5-qrcode@latest"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyUxkE-i1BWgmy8hZOPDS7qhRQN43R-RE3dFLesMoKCcilYDScqwIwwJA22nIclN5dw/exec";
const fullResult = document.getElementById("full-result");

let scanner;
let locked = false;              // 是否正在處理驗證中
let lastProcessedCode = null;    // 上一次實際處理過的條碼（關鍵防重複）
let lastScanTime = 0;            // 上一次掃描回調時間（過濾庫的快速重複）

/* 震動回饋 */
function vibrateSuccess() { if (navigator.vibrate) navigator.vibrate(300); }
function vibrateError() { if (navigator.vibrate) navigator.vibrate([100, 100, 100]); }

/* 全黑結果畫面 - 顯示 500ms */
function showFullResult(isSuccess, isVip = false, message = "") {
  if (isSuccess) {
    vibrateSuccess();
    fullResult.innerHTML = `
      <div class="checkmark">✓</div>
      ${isVip ? '<div class="vip">VIP<br>入場成功</div>' : '<div class="normal">入場成功</div>'}
    `;
  } else {
    vibrateError();
    fullResult.innerHTML = `
      <div class="normal">${message || '無效或已使用'}</div>
    `;
  }
  fullResult.style.display = "flex";
  setTimeout(() => {
    fullResult.style.display = "none";
    locked = false;  // 500ms 後一定解鎖
  }, 500);
}

/* API 驗證 */
async function verifyTicket(id) {
  try {
    const res = await fetch(API_URL + "?id=" + encodeURIComponent(id), { 
      cache: "no-cache"
    });
    const result = await res.json();

    if (result.status === "OK") {
      showFullResult(true, result.vip);
    } else if (result.status === "USED") {
      showFullResult(false, false, "票券已使用");
    } else if (result.status === "DUPLICATE") {
      locked = false;  // 重複掃同張票，直接解鎖不顯示
    } else {
      showFullResult(false);
    }
  } catch (err) {
    vibrateError();
    showFullResult(false, false, "網路錯誤");
    locked = false;  // 錯誤時也要解鎖
  }
}

/* 掃描成功回調 - 多層防重複機制 */
function onScan(decodedText) {
  const now = Date.now();
  const code = decodedText.trim();

  // 1. 過濾極短時間內的相同回調（庫本身會快速重複呼叫）
  if (now - lastScanTime < 80 && code === lastProcessedCode) {
    return;
  }

  // 2. 正在處理前一個驗證，直接忽略
  if (locked) {
    return;
  }

  // 3. 和上一次實際處理過的條碼完全一樣，直接忽略（避免條碼沒移開就重複觸發）
  if (code === lastProcessedCode) {
    return;
  }

  // 全部通過 → 這是一個真正的新條碼
  locked = true;
  lastScanTime = now;
  lastProcessedCode = code;

  verifyTicket(code);
}

/* 掃描設定 */
const config = {
  fps: 35,
  qrbox: { width: 280, height: 280 },
  aspectRatio: 1,
  disableFlip: false,
  formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ],
  experimentalFeatures: {
    useBarCodeDetectorIfSupported: true
  }
};

/* 啟動掃描器 */
scanner = new Html5Qrcode("qr-reader");
scanner.start(
  { facingMode: "environment" },  // 優先後置鏡頭
  config,
  onScan,
  () => {}  // 錯誤回調（可留空）
).catch(err => {
  alert("無法啟動相機：" + err);
});
</script>
</body>
</html>
